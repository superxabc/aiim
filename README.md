# AIIM - AI Instant Messaging

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python](https://img.shields.io/badge/python-3.11+-blue.svg)](https://www.python.org/downloads/)
[![FastAPI](https://img.shields.io/badge/FastAPI-0.111.0-green.svg)](https://fastapi.tiangolo.com/)
[![Docker](https://img.shields.io/badge/docker-%230db7ed.svg?style=flat&logo=docker&logoColor=white)](https://www.docker.com/)

AIIM v2.0æ˜¯ä¸€ä¸ªä¼ä¸šçº§å³æ—¶é€šè®¯ç³»ç»Ÿï¼Œä¸“ä¸ºAIåº”ç”¨åœºæ™¯è®¾è®¡ã€‚åŸºäºFastAPI + SQLAlchemy + Redisæ„å»ºï¼Œæ”¯æŒå®æ—¶æ¶ˆæ¯ä¼ é€’ã€éŸ³è§†é¢‘é€šè¯ã€AIæµå¼æ¶ˆæ¯å¤„ç†å’Œå¤šç«¯åŒæ­¥ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### åŸºç¡€IMåŠŸèƒ½
- ğŸš€ **å®æ—¶é€šä¿¡**: WebSocketåŒå‘é€šä¿¡ï¼Œæ”¯æŒè®¢é˜…/å‘å¸ƒæ¨¡å¼
- ğŸ”„ **æ¶ˆæ¯é¡ºåº**: åŸºäºRedisçš„ä¸¥æ ¼æ¶ˆæ¯åºåˆ—ä¿è¯
- ğŸ“± **å¤šç«¯åŒæ­¥**: æ”¯æŒå¤šè®¾å¤‡æ¶ˆæ¯åŒæ­¥å’ŒçŠ¶æ€ç®¡ç†
- ğŸ¤– **AIé›†æˆ**: åŸç”Ÿæ”¯æŒAIæµå¼æ¶ˆæ¯å¤„ç†
- ğŸ“Š **é€è¾¾å›æ‰§**: å®Œæ•´çš„æ¶ˆæ¯çŠ¶æ€è·Ÿè¸ªï¼ˆå·²å‘é€/å·²é€è¾¾/å·²è¯»ï¼‰

### éŸ³è§†é¢‘åŠŸèƒ½ (v2.0æ–°å¢)
- ğŸµ **è¯­éŸ³æ¶ˆæ¯**: å¼‚æ­¥è¯­éŸ³æ¶ˆæ¯å½•åˆ¶ã€ä¸Šä¼ ã€æ’­æ”¾
- ğŸ“ **å®æ—¶é€šè¯**: WebRTCéŸ³è§†é¢‘é€šè¯æ”¯æŒ
- ğŸ“ **åª’ä½“å­˜å‚¨**: é›†æˆMinIO/é˜¿é‡Œäº‘OSSå¯¹è±¡å­˜å‚¨
- ğŸŒ **NATç©¿è¶Š**: å†…ç½®STUN/TURNæœåŠ¡å™¨æ”¯æŒ

### ä¼ä¸šçº§ç‰¹æ€§
- ğŸ” **å¯è§‚æµ‹æ€§**: å†…ç½®å¥åº·æ£€æŸ¥ã€PrometheusæŒ‡æ ‡ç›‘æ§
- ğŸ” **å®‰å…¨è®¤è¯**: å¤šå±‚è®¤è¯ï¼ˆJWTã€API Keyã€å†…å®¹éªŒè¯ï¼‰
- ğŸ›¡ï¸ **å®‰å…¨åŠ å›º**: é€Ÿç‡é™åˆ¶ã€å®‰å…¨å¤´ã€é˜²æ”»å‡»æœºåˆ¶
- ğŸ“ˆ **é«˜å¯ç”¨**: æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ã€æ°´å¹³æ‰©å±•ã€ç”Ÿäº§å°±ç»ª

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å¼€å‘ç¯å¢ƒ

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/superxabc/aiim.git
cd aiim

# é…ç½®ç¯å¢ƒå˜é‡
cp env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œè®¾ç½® JWT_SECRET ç­‰é…ç½®

# å¯åŠ¨æœåŠ¡ï¼ˆåŒ…å«PostgreSQL + Redis + AIIMï¼‰
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f aiim
```

### æœ¬åœ°å¼€å‘

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
cp env.example .env

# è¿è¡Œå¼€å‘æœåŠ¡å™¨
DEV_AUTO_CREATE_TABLES=true uvicorn main:app --reload --port 8083
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

âš ï¸ **é‡è¦æé†’**ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è¯·ä½¿ç”¨ä¸“é—¨çš„éƒ¨ç½²è„šæœ¬ï¼Œæ”¯æŒåˆ†å¸ƒå¼æ¶æ„å’ŒéŸ³è§†é¢‘åŠŸèƒ½ã€‚

```bash
# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆæ¨èï¼‰
cd ../deployment-scripts

# ä¸»æœåŠ¡å™¨éƒ¨ç½²ï¼ˆECS-1: 2æ ¸2GBï¼‰
./orchestration/deploy_complete_aiim_cluster.sh --role main --media-server <åª’ä½“æœåŠ¡å™¨IP>

# åª’ä½“æœåŠ¡å™¨éƒ¨ç½²ï¼ˆECS-2: 2æ ¸4GBï¼‰  
./orchestration/deploy_complete_aiim_cluster.sh --role media --main-server <ä¸»æœåŠ¡å™¨IP>
```

è¯¦ç»†éƒ¨ç½²æ–‡æ¡£è¯·å‚è€ƒ [deployment-scripts/README.md](../deployment-scripts/README.md)

## ğŸ”§ é…ç½®è¯´æ˜

å…³é”®ç¯å¢ƒå˜é‡ï¼š

| å˜é‡å | æè¿° | é»˜è®¤å€¼ | å¿…å¡« |
|--------|------|--------|------|
| `JWT_SECRET` | JWTç­¾åå¯†é’¥ | - | âœ… |
| `DATABASE_URL` | æ•°æ®åº“è¿æ¥URL | `sqlite:///./im.db` | âŒ |
| `REDIS_URL` | Redisè¿æ¥URL | - | ç”Ÿäº§ç¯å¢ƒå¿…å¡« |
| `MINIO_ENDPOINT` | å¯¹è±¡å­˜å‚¨ç«¯ç‚¹ | `localhost:9000` | éŸ³è§†é¢‘åŠŸèƒ½å¿…å¡« |
| `MINIO_ACCESS_KEY` | å¯¹è±¡å­˜å‚¨è®¿é—®å¯†é’¥ | - | éŸ³è§†é¢‘åŠŸèƒ½å¿…å¡« |
| `STUN_SERVERS` | STUNæœåŠ¡å™¨åˆ—è¡¨ | Googleå…¬å…±STUN | âŒ |
| `TURN_SERVER` | TURNæœåŠ¡å™¨åœ°å€ | - | WebRTCé€šè¯æ¨è |
| `RATE_LIMIT_PER_SEC` | é€Ÿç‡é™åˆ¶ï¼ˆè¯·æ±‚/ç§’ï¼‰ | `10` | âŒ |

å®Œæ•´é…ç½®è¯·å‚è€ƒ `env.example` æ–‡ä»¶ã€‚

## ğŸ“‹ APIæ¦‚è§ˆ

### REST APIï¼ˆéœ€ Authorization: Bearer <JWT>ï¼‰

**åŸºç¡€IMåŠŸèƒ½:**
- `POST /api/aiim/conversations` - åˆ›å»ºä¼šè¯
- `GET /api/aiim/conversations` - è·å–ä¼šè¯åˆ—è¡¨
- `POST /api/aiim/messages` - å‘é€æ¶ˆæ¯ï¼ˆæ”¯æŒæ–‡æœ¬ã€éŸ³é¢‘ç­‰ï¼‰
- `GET /api/aiim/messages/{conversation_id}` - è·å–æ¶ˆæ¯å†å²
- `POST /api/aiim/messages/stream` - æµå¼æ¶ˆæ¯å‘é€

**åª’ä½“åŠŸèƒ½ (v2.0):**
- `POST /api/aiim/media/upload_token` - è·å–åª’ä½“ä¸Šä¼ ä»¤ç‰Œ
- `POST /api/aiim/media/upload_complete` - å®Œæˆåª’ä½“ä¸Šä¼ 
- `GET /api/aiim/media/{media_id}/download` - ä¸‹è½½åª’ä½“æ–‡ä»¶
- `GET /api/aiim/media/{media_id}/metadata` - è·å–åª’ä½“å…ƒæ•°æ®

**é€šè¯åŠŸèƒ½ (v2.0):**
- `POST /api/aiim/calls/initiate` - å‘èµ·é€šè¯
- `POST /api/aiim/calls/{call_id}/accept` - æ¥å—é€šè¯
- `POST /api/aiim/calls/{call_id}/reject` - æ‹’ç»é€šè¯
- `POST /api/aiim/calls/{call_id}/hangup` - æŒ‚æ–­é€šè¯
- `GET /api/aiim/calls/ice-configuration` - è·å–WebRTCé…ç½®

### WebSocket `/api/aiim/ws?token=<JWT>`

**æ¶ˆæ¯åŠŸèƒ½:**
- `subscribe`/`unsubscribe` - è®¢é˜…/å–æ¶ˆè®¢é˜…ä¼šè¯
- `send_msg` â†’ æ¶ˆæ¯å‘é€ç¡®è®¤ + `message.created` äº‹ä»¶
- `stream_chunk` â†’ æµå¼æ¶ˆæ¯ç‰‡æ®µ + `message.stream_chunk` äº‹ä»¶
- `delivered` - æ¶ˆæ¯é€è¾¾å›æ‰§

**é€šè¯åŠŸèƒ½ (v2.0):**
- `call.initiate` - å‘èµ·é€šè¯ä¿¡ä»¤
- `call.webrtc.signal` - WebRTCä¿¡ä»¤äº¤æ¢
- `call.accept`/`call.reject`/`call.hangup` - é€šè¯æ§åˆ¶

**ç³»ç»ŸåŠŸèƒ½:**
- `ping`/`pong` - å¿ƒè·³ä¿æ´» + åœ¨çº¿çŠ¶æ€ç»´æŠ¤

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client Apps   â”‚    â”‚   AI Services   â”‚    â”‚   Admin Panel   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                      â”‚
          â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  AIIM Gateway â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚  (FastAPI)    â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚            â”‚            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Message Bus  â”‚   â”‚   â”‚   Auth & Rate   â”‚
            â”‚  (Redis)      â”‚   â”‚   â”‚   Limiter       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   PostgreSQL    â”‚
                       â”‚   (Messages,    â”‚
                       â”‚   Conversations)â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

**åº”ç”¨æ¡†æ¶:**
- **FastAPI**: å¼‚æ­¥Webæ¡†æ¶ï¼Œæä¾›REST APIå’ŒWebSocketæ”¯æŒ
- **SQLAlchemy**: ORMæ¡†æ¶ï¼Œæ”¯æŒPostgreSQLå’ŒSQLite
- **Alembic**: æ•°æ®åº“è¿ç§»å·¥å…·

**å­˜å‚¨ä¸ç¼“å­˜:**
- **PostgreSQL**: ä¸»æ•°æ®åº“ï¼Œå­˜å‚¨æ¶ˆæ¯ã€ä¼šè¯ã€é€šè¯è®°å½•
- **Redis**: æ¶ˆæ¯é˜Ÿåˆ—ã€åºåˆ—ç”Ÿæˆã€åœ¨çº¿çŠ¶æ€ç®¡ç†
- **MinIO/é˜¿é‡Œäº‘OSS**: å¯¹è±¡å­˜å‚¨ï¼Œç”¨äºåª’ä½“æ–‡ä»¶

**é€šä¿¡ä¸å®‰å…¨:**
- **WebRTC**: å®æ—¶éŸ³è§†é¢‘é€šè¯æŠ€æœ¯
- **coturn**: STUN/TURNæœåŠ¡å™¨ï¼ŒNATç©¿è¶Š
- **JWT**: èº«ä»½è®¤è¯å’Œæˆæƒ

**ç›‘æ§ä¸è¿ç»´:**
- **Prometheus**: æŒ‡æ ‡ç›‘æ§å’Œå‘Šè­¦
- **Nginx**: åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡
- **Docker**: å®¹å™¨åŒ–éƒ¨ç½²

### é¡¹ç›®ç»“æ„

```
aiim/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/           # APIè·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ im_api.py      # åŸºç¡€IMæ¥å£
â”‚   â”‚   â”œâ”€â”€ im_ws.py       # WebSocketå®æ—¶é€šä¿¡
â”‚   â”‚   â”œâ”€â”€ media_api.py   # åª’ä½“æ–‡ä»¶æ¥å£ (NEW)
â”‚   â”‚   â””â”€â”€ call_api.py    # é€šè¯ç®¡ç†æ¥å£ (NEW)
â”‚   â”œâ”€â”€ core/          # æ ¸å¿ƒåŠŸèƒ½
â”‚   â”‚   â”œâ”€â”€ config.py          # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ media_storage.py   # åª’ä½“å­˜å‚¨æœåŠ¡ (NEW)
â”‚   â”‚   â”œâ”€â”€ turn_service.py    # TURNæœåŠ¡é›†æˆ (NEW)
â”‚   â”‚   â”œâ”€â”€ security.py        # å®‰å…¨ä¸­é—´ä»¶ (NEW)
â”‚   â”‚   â””â”€â”€ monitoring.py      # ç›‘æ§ç³»ç»Ÿ (NEW)
â”‚   â”œâ”€â”€ models/        # æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ im.py          # æ‰©å±•æ”¯æŒéŸ³è§†é¢‘æ¶ˆæ¯
â”‚   â””â”€â”€ services/      # ä¸šåŠ¡é€»è¾‘å±‚
â”‚       â””â”€â”€ call_service.py    # é€šè¯ç®¡ç†æœåŠ¡ (NEW)
â”œâ”€â”€ alembic/           # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ docker-compose.yml         # å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ docker-compose.prod.yml    # ç”Ÿäº§ç¯å¢ƒåŸºç¡€é…ç½®
â””â”€â”€ env.production.example     # ç”Ÿäº§ç¯å¢ƒé…ç½®æ¨¡æ¿ (NEW)
```

## ğŸ“š APIæ–‡æ¡£

å¯åŠ¨æœåŠ¡åï¼Œè®¿é—®ä»¥ä¸‹åœ°å€æŸ¥çœ‹APIæ–‡æ¡£ï¼š

- **Swagger UI**: http://localhost:8083/docs
- **ReDoc**: http://localhost:8083/redoc
- **å¥åº·æ£€æŸ¥**: http://localhost:8083/health
- **ç›‘æ§æŒ‡æ ‡**: http://localhost:8083/metrics

### APIæµ‹è¯•

1. **å¼€å‘ç¯å¢ƒ**: æŸ¥çœ‹ `/docs` æˆ– `/redoc` è¿›è¡Œäº¤äº’å¼APIæµ‹è¯•
2. **ç”Ÿäº§ç¯å¢ƒ**: ä½¿ç”¨ä¸“ä¸šAPIæµ‹è¯•å·¥å…·ï¼Œå‚è€ƒæŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£ä¸­çš„APIè§„èŒƒ

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œè¦†ç›–ç‡æµ‹è¯•
pytest --cov=app tests/

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/test_im_service.py -v
```

## ğŸš€ ç”Ÿäº§éƒ¨ç½²

### ç¯å¢ƒè¦æ±‚

**åŸºç¡€è¿è¡Œç¯å¢ƒ:**
- **Python**: 3.11+
- **æ•°æ®åº“**: PostgreSQL 15+ (æ¨è) æˆ– SQLite (å¼€å‘)
- **ç¼“å­˜**: Redis 7+ (ç”Ÿäº§å¿…éœ€)
- **å®¹å™¨**: Docker + Docker Compose

**éŸ³è§†é¢‘åŠŸèƒ½ä¾èµ– (v2.0):**
- **å¯¹è±¡å­˜å‚¨**: MinIO æˆ– é˜¿é‡Œäº‘OSS
- **TURNæœåŠ¡å™¨**: coturn (ç”¨äºNATç©¿è¶Š)
- **è´Ÿè½½å‡è¡¡**: Nginx (ç”Ÿäº§ç¯å¢ƒ)

### åˆ†å¸ƒå¼éƒ¨ç½²æ¶æ„

```
ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®:
â”œâ”€â”€ ECS-1 (2æ ¸2GB) - ä¸»åº”ç”¨æœåŠ¡å™¨
â”‚   â”œâ”€â”€ AIIMåº”ç”¨ + PostgreSQL + Redis
â”‚   â””â”€â”€ Nginxåå‘ä»£ç†
â””â”€â”€ ECS-2 (2æ ¸4GB) - åª’ä½“æœåŠ¡å™¨  
    â”œâ”€â”€ coturn (TURNæœåŠ¡å™¨)
    â””â”€â”€ MinIO (å¯¹è±¡å­˜å‚¨)
```

### ç›‘æ§å’Œå¯è§‚æµ‹æ€§

- **å¥åº·æ£€æŸ¥**: `/health`, `/healthz`, `/ready`
- **PrometheusæŒ‡æ ‡**: `/metrics` - ä¸šåŠ¡å’Œç³»ç»ŸæŒ‡æ ‡
- **ç»“æ„åŒ–æ—¥å¿—**: JSONæ ¼å¼ï¼Œæ”¯æŒé›†ä¸­åŒ–æ—¥å¿—æ”¶é›†
- **æ€§èƒ½ç›‘æ§**: è¯·æ±‚å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€èµ„æºä½¿ç”¨æƒ…å†µ

## ğŸ¤ è´¡çŒ®

æˆ‘ä»¬æ¬¢è¿å„ç§å½¢å¼çš„è´¡çŒ®ï¼

### å¿«é€Ÿå¼€å§‹è´¡çŒ®

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯: `git checkout -b feature/amazing-feature`
3. æäº¤æ›´æ”¹: `git commit -m 'Add amazing feature'`
4. æ¨é€åˆ†æ”¯: `git push origin feature/amazing-feature`
5. åˆ›å»º Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ”— ç›¸å…³é“¾æ¥

- [æŠ€æœ¯æ¶æ„æ–‡æ¡£](aiimæŠ€æœ¯æ–¹æ¡ˆ-v2.md) - è¯¦ç»†çš„v2.0æŠ€æœ¯æ–¹æ¡ˆ
- [éƒ¨ç½²è„šæœ¬æ–‡æ¡£](../deployment-scripts/README.md) - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

## ğŸ“ æ”¯æŒ

- ğŸ› [æŠ¥å‘ŠBug](https://github.com/superxabc/aiim/issues)
- ğŸ’¡ [åŠŸèƒ½è¯·æ±‚](https://github.com/superxabc/aiim/issues)
- ğŸ“§ æŠ€æœ¯æ”¯æŒï¼šé€šè¿‡GitHub Issues

---

â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™æˆ‘ä»¬ä¸€ä¸ªæ˜Ÿæ˜Ÿï¼
