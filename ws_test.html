<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIIM WebSocket 测试</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:20px}
    .row{margin:8px 0}
    textarea{width:100%;height:120px}
    input[type=text]{width:100%}
    pre{background:#111;color:#0f0;padding:10px;white-space:pre-wrap}
    button{padding:8px 12px;margin-right:8px}
  </style>
  <script>
    let ws;
    function log(msg){
      const out=document.getElementById('out');
      out.textContent += (typeof msg==='string'?msg:JSON.stringify(msg))+'\n';
      out.scrollTop = out.scrollHeight;
    }
    function connect(){
      const token=document.getElementById('token').value.trim();
      const host=(location.hostname && location.hostname.length>0) ? location.hostname : '127.0.0.1';
      const url=`ws://${host}:8083/api/aiim/ws?token=${encodeURIComponent(token)}`;
      ws = new WebSocket(url);
      ws.onopen = ()=> log('WS connected');
      ws.onclose = (e)=> log('WS closed: '+e.code);
      ws.onerror = (e)=> log('WS error');
      ws.onmessage = (e)=>{
        try{ log(JSON.parse(e.data)); }catch{ log(e.data); }
      };
    }
    function sendJson(obj){ if(ws && ws.readyState===1){ ws.send(JSON.stringify(obj)); } }
    function subscribe(){
      const conv=document.getElementById('conv').value.trim();
      sendJson({type:'subscribe', conversation_id: conv});
    }
    function unsubscribe(){
      const conv=document.getElementById('conv').value.trim();
      sendJson({type:'unsubscribe', conversation_id: conv});
    }
    function sendMsg(){
      const conv=document.getElementById('conv').value.trim();
      const text=document.getElementById('text').value;
      sendJson({type:'send_msg', conversation_id: conv, msg_type:'text', content:{text}, client_msg_id: 'web-'+Date.now()});
    }
    function sendChunk(end){
      const conv=document.getElementById('conv').value.trim();
      const text=document.getElementById('text').value;
      sendJson({type:'stream_chunk', conversation_id: conv, chunk: text, stream_end: !!end, client_msg_id: 'stream-'+Date.now()});
    }
    function ping(){ sendJson({type:'pong'}); }
    function disconnect(){
      if (ws) {
        try { ws.close(1000, 'bye'); } catch (e) {}
        log('WS closed by client');
        ws = null;
      }
    }
  </script>
</head>
<body>
  <h3>AIIM WebSocket 测试</h3>
  <div class="row">
    <label>JWT Token</label>
    <input id="token" type="text" placeholder="粘贴通过 /health 脚本或容器生成的 JWT" />
  </div>
  <div class="row">
    <button onclick="connect()">连接</button>
    <button onclick="disconnect()">断开</button>
  </div>
  <div class="row">
    <label>Conversation ID</label>
    <input id="conv" type="text" placeholder="创建会话后填入 conversation_id" />
  </div>
  <div class="row">
    <button onclick="subscribe()">订阅</button>
    <button onclick="unsubscribe()">取消订阅</button>
  </div>
  <div class="row">
    <label>消息内容（text 或 stream chunk）</label>
    <textarea id="text" placeholder="hello"></textarea>
  </div>
  <div class="row">
    <button onclick="sendMsg()">发送消息(send_msg)</button>
    <button onclick="sendChunk(false)">发送流片(stream_chunk)</button>
    <button onclick="sendChunk(true)">发送流结束(stream_end=true)</button>
    <button onclick="ping()">PONG(保持心跳)</button>
  </div>
  <pre id="out"></pre>
</body>
</html>


